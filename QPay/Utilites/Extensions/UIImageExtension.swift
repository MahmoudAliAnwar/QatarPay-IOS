//
//  UIImageViewExtension.swift
//  QPay
//
//  Created by Dev. Mohmd on 8/30/20.
//  Copyright Â© 2020 Dev. Mohmd. All rights reserved.
//

import Foundation
import UIKit

extension UIImage {
    
    /// Project Image
    static let errorCircle                     = Images.ic_error_circle.image,
               ic_avatar                       = Images.ic_avatar.image,
               ic_transaction_person           = Images.ic_transaction_person.image,
               ic_maroon_card_home             = Images.ic_maroon_card_home.image,
               ic_blue_card_home               = Images.ic_blue_card_home.image,
               ic_black_card_home              = Images.ic_black_card_home.image,
               ic_mastercard_my_library        = Images.ic_mastercard_my_library.image,
               ic_diners_club_my_library       = Images.ic_diners_club_my_library.image,
               ic_maestro_my_library           = Images.ic_maestro_my_library.image,
               ic_scan_qr_code                 = Images.ic_scan_qr_code.image,
               ic_vendex_qrcode                = Images.ic_vendex_qrcode.image,
               ic_topup_money_transfer         = Images.ic_topup_money_transfer.image,
               ic_transfer_money_transfer      = Images.ic_transfer_money_transfer.image,
               ic_request_money_transfer       = Images.ic_request_money_transfer.image,
               ic_arrow_money_transfer         = Images.ic_arrow_money_transfer.image,
               bg_analytics_red                = Images.bg_analytics_red.image,
               bg_analytics_blue               = Images.bg_analytics_blue.image,
               ic_arrow_down_transfer          = Images.ic_arrow_down_transfer.image,
               ic_arrow_right_transfer         = Images.ic_arrow_right_transfer.image,
               ic_arrow_down_gray              = Images.ic_arrow_down_gray.image,
               ic_arrow_right_kahramaa         = Images.ic_arrow_right_kahramaa.image,
               ic_search_my_shops              = Images.ic_search_my_shops.image,
               ic_arrow_up_my_book_product     = Images.ic_arrow_up_my_book_product.image,
               ic_arrow_down_my_book_product   = Images.ic_arrow_down_my_book_product.image,
               bg_btn_qmobile                  = Images.bg_btn_qmobile.image,
               ic_person_settings              = Images.ic_person_settings.image,
               ic_address_settings             = Images.ic_address_settings.image,
               ic_lock_settings                = Images.ic_lock_settings.image,
               ic_invite_settings              = Images.ic_invite_settings.image,
               ic_contact_us_settings          = Images.ic_contact_us_settings.image,
               ic_logout_settings              = Images.ic_logout_settings.image,
               ic_visa_card_details            = Images.ic_visa_card_details.image,
               ic_visa_logo_card               = Images.ic_visa_logo_card.image,
               ic_mastercard_card_details      = Images.ic_mastercard_card_details.image,
               ic_unknown_card_details         = Images.ic_unknown_card_details.image,
               ic_edit_personal_info           = Images.ic_edit_personal_info.image,
               ic_verified_personal_info       = Images.ic_verified_personal_info.image,
               ic_unverified_personal_info     = Images.ic_unverified_personal_info.image,
               ic_eye_personal_info            = Images.ic_eye_personal_info.image,
               ic_reset_personal_info          = Images.ic_reset_personal_info.image,
               ic_naps_checkout                = Images.ic_naps_checkout.image,
               ic_credit_card_payment_method   = Images.ic_credit_card_payment_method.image,
               ic_ooredoo_payment_method       = Images.ic_ooredoo_payment_method.image,
               ic_ooredoo_money_payment_method = Images.ic_ooredoo_money_payment_method.image,
               ic_vodafone_checkout            = Images.ic_vodafone_checkout.image,
               ic_paypal_payment_method        = Images.ic_paypal_payment_method.image,
               ic_metro_rail_card              = Images.ic_metro_rail_card.image,
               ic_karwa_card                   = Images.ic_karwa_card.image,
               ic_cv_skills                    = Images.ic_cv_skills.image,
               bg_cv_skills                    = Images.bg_cv_skills.image,
               ic_cv_personal_information      = Images.ic_cv_personal_information.image,
               bg_cv_personal_information      = Images.bg_cv_personal_information.image,
               ic_cv_expertise                 = Images.ic_cv_expertise.image,
               bg_cv_expertise                 = Images.bg_cv_expertise.image,
               ic_avatar_photo                 = Images.ic_avatar_photo.image,
               ic_cv_job                       = Images.ic_cv_job.image,
               ic_cv_lock_red                  = Images.ic_cv_lock_red.image,
               ic_cv_lock                      = Images.ic_cv_lock.image,
               job_hunt_profile_image          = Images.job_hunt_profile_image.image,
               company_logo_image              = Images.company_logo_image.image,
               ic_save_limousine               = Images.ic_save_limousine.image ,
               bg_limousine_navigation         = Images.bg_limousine_navigation.image,
               bg_limousine_tab                = Images.bg_limousine_tab.image,
               bg_limousine_qatar              = Images.bg_limousine_qatar.image,
               bg_child_Care_navigation        = Images.bg_child_Care_navigation.image,
               bg_child_Care_tab               = Images.bg_child_Care_tab.image,
               bg_hotel_navigation             = Images.bg_hotel_navigation.image,
               bg_hotel_tab                    = Images.bg_hotel_tab.image,
               bg_hotel_qatar                  = Images.bg_hotel_qatar.image,
               bg_dine_navigation              = Images.bg_dine_navigation.image,
               bg_dine_qater                   = Images.bg_dine_qater.image,
               bg_dine_tab                     = Images.bg_dine_tab.image,
               bg_insurance_navigation         = Images.bg_insurance_navigation.image,
               bg_insurance_qater              = Images.bg_insurance_qater.image,
               bg_insurance_tab                = Images.bg_insurance_tab.image,
               bg_medical_center_tab           = Images.bg_medical_center_tab.image,
               bg_medical_center_navigation    = Images.bg_medical_center_navigation.image,
               bg_medical_center_qatar         = Images.bg_medical_center_qatar.image,
               bg_qater_school_navigation      = Images.bg_qater_school_navigation.image,
               bg_school_qater                 = Images.bg_school_qater.image,
               bg_qater_School_tab             = Images.bg_qater_School_tab.image,
               stock_history                   = Images.stock_history.image,
               stock_index                     = Images.stock_index.image,
               stock_market                    = Images.stock_market.image,
               stock_mystocks                  = Images.stock_mystocks.image,
               stock_news                      = Images.stock_news.image,
               credit_inactive                 = Images.credit_inactive.image,
               qatar_avatar_ic                 = Images.qatar_avatar_ic.image 
    
    
    
    
    
    /// System Image
    static let eye_slash = Images.eye_slash.image,
               eye = Images.eye.image
    
    static func imageWithColor(_ color: UIColor, size: CGSize) -> UIImage {
        let rect: CGRect = CGRect(origin: CGPoint(x: 0,y :0), size: CGSize(width: size.width, height: size.height))
        UIGraphicsBeginImageContextWithOptions(size, false, 0)
        color.setFill()
        UIRectFill(rect)
        let image: UIImage = UIGraphicsGetImageFromCurrentImageContext()!
        UIGraphicsEndImageContext()
        return image
    }
    
    public func detectQRCode() -> [CIFeature]? {
        
        if let ciImage = CIImage(image: self){
            var options: [String: Any]
            let context = CIContext()
            options = [CIDetectorAccuracy: CIDetectorAccuracyHigh]
            let qrDetector = CIDetector(ofType: CIDetectorTypeQRCode, context: context, options: options)
            if ciImage.properties.keys.contains((kCGImagePropertyOrientation as String)){
                options = [CIDetectorImageOrientation: ciImage.properties[(kCGImagePropertyOrientation as String)] ?? 1]
            } else {
                options = [CIDetectorImageOrientation: 1]
            }
            let features = qrDetector?.features(in: ciImage, options: options)
            return features
            
        }
        return nil
    }
    
    public func rounded() -> UIImage {
        
        let imageView: UIImageView = UIImageView(image: self)
        let layer = imageView.layer
        layer.masksToBounds = true
        layer.cornerRadius = self.size.height / 2
        UIGraphicsBeginImageContext(imageView.bounds.size)
        layer.render(in: UIGraphicsGetCurrentContext()!)
        let roundedImage = UIGraphicsGetImageFromCurrentImageContext()
        UIGraphicsEndImageContext()
        return roundedImage!
    }
    
    public func convertImageToBase64String(img: UIImage) -> String {
        return self.jpegData(compressionQuality: 1)?.base64EncodedString() ?? ""
    }
    
    func circularImage(size: CGSize?) -> UIImage {
        let newSize = size ?? self.size
        
        let minEdge = min(newSize.height, newSize.width)
        let size = CGSize(width: minEdge, height: minEdge)
        
        UIGraphicsBeginImageContextWithOptions(size, false, 0.0)
        let context = UIGraphicsGetCurrentContext()
        
        self.draw(in: CGRect(origin: CGPoint.zero, size: size), blendMode: .copy, alpha: 1.0)
        
        context!.setBlendMode(.copy)
        context!.setFillColor(UIColor.clear.cgColor)
        
        let rectPath = UIBezierPath(rect: CGRect(origin: CGPoint.zero, size: size))
        let circlePath = UIBezierPath(ovalIn: CGRect(origin: CGPoint.zero, size: size))
        rectPath.append(circlePath)
        rectPath.usesEvenOddFillRule = true
        rectPath.fill()
        
        let result = UIGraphicsGetImageFromCurrentImageContext()
        UIGraphicsEndImageContext()
        
        return result!
    }
    
    // MARK: - GIF
    
    public class func gif(data: Data) -> UIImage? {
        // Create source from data
        guard let source = CGImageSourceCreateWithData(data as CFData, nil) else {
            print("SwiftGif: Source for the image does not exist")
            return nil
        }
        
        return UIImage.animatedImageWithSource(source)
    }
    
    public class func gif(url: String) -> UIImage? {
        // Validate URL
        guard let bundleURL = URL(string: url) else {
            print("SwiftGif: This image named \"\(url)\" does not exist")
            return nil
        }
        
        // Validate data
        guard let imageData = try? Data(contentsOf: bundleURL) else {
            print("SwiftGif: Cannot turn image named \"\(url)\" into NSData")
            return nil
        }
        
        return gif(data: imageData)
    }
    
    public class func gif(name: String) -> UIImage? {
        // Check for existance of gif
        guard let bundleURL = Bundle.main
            .url(forResource: name, withExtension: "gif") else {
            print("SwiftGif: This image named \"\(name)\" does not exist")
            return nil
        }
        
        // Validate data
        guard let imageData = try? Data(contentsOf: bundleURL) else {
            print("SwiftGif: Cannot turn image named \"\(name)\" into NSData")
            return nil
        }
        
        return gif(data: imageData)
    }
    
    @available(iOS 9.0, *)
    public class func gif(asset: String) -> UIImage? {
        // Create source from assets catalog
        guard let dataAsset = NSDataAsset(name: asset) else {
            print("SwiftGif: Cannot turn image named \"\(asset)\" into NSDataAsset")
            return nil
        }
        
        return gif(data: dataAsset.data)
    }
    
    public class func delayForImageAtIndex(_ index: Int, source: CGImageSource!) -> Double {
        var delay = 0.1
        
        // Get dictionaries
        let cfProperties = CGImageSourceCopyPropertiesAtIndex(source, index, nil)
        let gifPropertiesPointer = UnsafeMutablePointer<UnsafeRawPointer?>.allocate(capacity: 0)
        defer {
            gifPropertiesPointer.deallocate()
        }
        let unsafePointer = Unmanaged.passUnretained(kCGImagePropertyGIFDictionary).toOpaque()
        if CFDictionaryGetValueIfPresent(cfProperties, unsafePointer, gifPropertiesPointer) == false {
            return delay
        }
        
        let gifProperties: CFDictionary = unsafeBitCast(gifPropertiesPointer.pointee, to: CFDictionary.self)
        
        // Get delay time
        var delayObject: AnyObject = unsafeBitCast(
            CFDictionaryGetValue(gifProperties,
                                 Unmanaged.passUnretained(kCGImagePropertyGIFUnclampedDelayTime).toOpaque()),
            to: AnyObject.self)
        if delayObject.doubleValue == 0 {
            delayObject = unsafeBitCast(CFDictionaryGetValue(gifProperties,
                                                             Unmanaged.passUnretained(kCGImagePropertyGIFDelayTime).toOpaque()), to: AnyObject.self)
        }
        
        if let delayObject = delayObject as? Double, delayObject > 0 {
            delay = delayObject
        } else {
            delay = 0.1 // Make sure they're not too fast
        }
        
        return delay
    }
    
    public class func gcdForPair(_ lhs: Int?, _ rhs: Int?) -> Int {
        var lhs = lhs
        var rhs = rhs
        // Check if one of them is nil
        if rhs == nil || lhs == nil {
            if rhs != nil {
                return rhs!
            } else if lhs != nil {
                return lhs!
            } else {
                return 0
            }
        }
        
        // Swap for modulo
        if lhs! < rhs! {
            let ctp = lhs
            lhs = rhs
            rhs = ctp
        }
        
        // Get greatest common divisor
        var rest: Int
        while true {
            rest = lhs! % rhs!
            
            if rest == 0 {
                return rhs! // Found it
            } else {
                lhs = rhs
                rhs = rest
            }
        }
    }
    
    public class func gcdForArray(_ array: [Int]) -> Int {
        if array.isEmpty {
            return 1
        }
        
        var gcd = array[0]
        
        for val in array {
            gcd = UIImage.gcdForPair(val, gcd)
        }
        
        return gcd
    }
    
    public class func animatedImageWithSource(_ source: CGImageSource) -> UIImage? {
        let count = CGImageSourceGetCount(source)
        var images = [CGImage]()
        var delays = [Int]()
        
        // Fill arrays
        for index in 0..<count {
            // Add image
            if let image = CGImageSourceCreateImageAtIndex(source, index, nil) {
                images.append(image)
            }
            
            // At it's delay in cs
            let delaySeconds = UIImage.delayForImageAtIndex(Int(index),
                                                            source: source)
            delays.append(Int(delaySeconds * 1000.0)) // Seconds to ms
        }
        
        // Calculate full duration
        let duration: Int = {
            var sum = 0
            
            for val: Int in delays {
                sum += val
            }
            
            return sum
        }()
        
        // Get frames
        let gcd = gcdForArray(delays)
        var frames = [UIImage]()
        
        var frame: UIImage
        var frameCount: Int
        for index in 0..<count {
            frame = UIImage(cgImage: images[Int(index)])
            frameCount = Int(delays[Int(index)] / gcd)
            
            for _ in 0..<frameCount {
                frames.append(frame)
            }
        }
        
        // Heyhey
        let animation = UIImage.animatedImage(with: frames,
                                              duration: Double(duration) / 1000.0)
        
        return animation
    }
}
